import dotenv from 'dotenv'
import pg from 'pg'

dotenv.config()

const { Pool } = pg

const CONNECTION_STRING = process.env.DATABASE_URL || 'postgres://postgres:postgres@localhost:5432/dla_lms'
const pool = new Pool({ connectionString: CONNECTION_STRING })

export async function query(sql, params) {
  const client = await pool.connect()
  try {
    const res = await client.query(sql, params)
    return res
  } finally {
    client.release()
  }
}

async function ensureDatabaseExists() {
  try {
    // simple query to check
    await query('select 1')
  } catch (err) {
    if (err?.code === '3D000') {
      // database does not exist: connect to default 'postgres' and create it
      const url = new URL(CONNECTION_STRING)
      const dbName = url.pathname.replace('/', '')
      url.pathname = '/postgres'
      const adminPool = new Pool({ connectionString: url.toString() })
      try {
        await adminPool.query(`create database ${JSON.stringify(dbName).replace(/"/g,'')}`)
        await adminPool.end()
      } catch (e) {
        await adminPool.end()
        throw e
      }
    } else {
      throw err
    }
  }
}

export async function initSchema() {
  await ensureDatabaseExists()
  await query(`
    create table if not exists faq (
      id integer primary key,
      category text not null,
      question text not null,
      answer text not null
    );

    create table if not exists support_categories (
      value text primary key,
      label text not null
    );

    create table if not exists contact_info (
      id integer primary key default 1,
      email text,
      phone text,
      address text,
      weekdays text,
      weekends text,
      resp_email text,
      resp_phone text,
      resp_chat text
    );

    create table if not exists chat_responses (
      id integer primary key,
      message text not null,
      timestamp timestamptz,
      sender text,
      typing boolean default false
    );

    create table if not exists quick_actions (
      id serial primary key,
      title text not null,
      description text,
      icon text,
      action text
    );

    create table if not exists support_stats (
      id integer primary key default 1,
      average_response_time text,
      satisfaction_rate text,
      resolved_tickets integer,
      active_agents integer
    );

    create table if not exists features (
      id integer primary key,
      title text not null,
      description text,
      icon text,
      color text
    );

    create table if not exists partners (
      id integer primary key,
      name text,
      logo text
    );

    create table if not exists stories (
      id integer primary key,
      name text,
      role text,
      avatar text,
      quote text,
      score text,
      country text
    );

    create table if not exists testimonial_stats (
      id integer primary key default 1,
      total_students text,
      average_improvement text,
      success_rate text,
      countries text
    );

    -- Materials: uploaded videos by admin
    create table if not exists materials_videos (
      id serial primary key,
      title text not null,
      description text,
      url text not null,
      created_by integer references users(id) on delete set null,
      created_at timestamptz default now()
    );

    create table if not exists users (
      id serial primary key,
      name text,
      email text,
      phone text,
      date_of_birth date,
      nationality text,
      avatar text,
      consent_given boolean,
      ui_language text,
      email_notifications boolean,
      sms_notifications boolean,
      test_reminders boolean,
      class_reminders boolean,
      progress_reminders boolean,
      two_factor_enabled boolean
    );

    create table if not exists login_history (
      id integer primary key,
      user_id integer references users(id) on delete cascade,
      date timestamptz,
      ip text,
      device text
    );

    create table if not exists skill_focus (
      user_id integer references users(id) on delete cascade,
      value text,
      primary key (user_id, value)
    );
  `)

  // Ensure newer columns exist
  await query('alter table if exists users add column if not exists role text')
  await query('alter table if exists users add column if not exists password_hash text')
  // Extend materials_videos with full metadata
  await query('alter table if exists materials_videos add column if not exists course_id integer')
  // Make course_id auto-increment if possible (optional identity)
  try {
    await query('alter table if exists materials_videos alter column course_id add generated by default as identity')
  } catch (e) {
    console.warn('Skipping add identity for course_id:', e?.message || e)
  }
  await query('alter table if exists materials_videos add column if not exists skill text')
  await query('alter table if exists materials_videos add column if not exists level text')
  await query('alter table if exists materials_videos add column if not exists cefr_level text')
  await query('alter table if exists materials_videos add column if not exists tags jsonb')
  await query('alter table if exists materials_videos add column if not exists thumbnail text')
  await query('alter table if exists materials_videos add column if not exists completed boolean')
  await query('alter table if exists materials_videos add column if not exists chapters jsonb')
  await query('alter table if exists materials_videos add column if not exists notes jsonb')
  await query('alter table if exists materials_videos add column if not exists subtitles jsonb')
  // Remove deprecated columns
  await query('alter table if exists materials_videos drop column if exists duration')
  await query('alter table if exists materials_videos drop column if exists duration_sec')
  await query('alter table if exists materials_videos drop column if exists progress')
  try {
    await query(`
      DO $$
      BEGIN
        IF NOT EXISTS (
          SELECT 1 FROM pg_constraint WHERE conname = 'users_email_unique'
        ) THEN
          ALTER TABLE IF EXISTS users ADD CONSTRAINT users_email_unique UNIQUE (email);
        END IF;
      END $$;
    `)
  } catch (e) {
    console.warn('Skipping users.email unique constraint:', e?.message || e)
  }
}

export default pool